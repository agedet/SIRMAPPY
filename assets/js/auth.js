const FACEBOOK_SDK_URL="/assets/js/vendors/fb-sdk.js",GOOGLE_SDK_URL="https://apis.google.com/js/client:platform.js?onload=googleAuthInit";var COOOKIE_DOMAIN=".bitsgap.com";function build2FAWindow(e,o,n){(window.location.pathname.search("/sign-in")>-1?$("main"):$("#login-popup .ath-body")).load("/sign-in/2fa/ .ath-container",(function(){n?resetTwoFACodeInput(sendCodeSocial,n,o):resetTwoFACodeInput(sendCode,o),e?$("#makeU2fLogin").on("click",(function(e){e.preventDefault(),buildU2FWindow(!0,o,n)})):$('p:has("#makeU2fLogin")').hide()}))}function buildU2FWindow(e,o,n){const t=window.location.pathname.search("/sign-in")>-1?$("main"):$("#login-popup .ath-body");u2fLoginBegin(o,n),t.load("/sign-in/u2f/ .ath-container",(function(){e?$("#mfaLogin").on("click",(function(e){e.preventDefault(),build2FAWindow(!0,o,n)})):$('p:has("#mfaLogin")').hide(),$("#u2fLogin").on("click",(function(e){e.preventDefault(),u2fLoginBegin(o,n)})),$("#u2fhelp").on("click",(function(e){e.preventDefault(),e.stopPropagation(),Intercom("show")}))}))}function login(e){e.preventDefault(),e.stopPropagation();var o=$("#lpassword").val(),n=$("#lemail").val(),t=window.innerWidth+"x"+window.innerHeight,a=window.screen.width+"x"+window.screen.height,r=new jsSHA("SHA-512","TEXT");r.update(n.toLowerCase()+o);var i={email:n,passw:r.getHash("HEX"),code:null,res:t,scr:a};$("#loginErrors").text("").removeClass("tc-warning tc-danger").hide(),$.ajax({type:"POST",data:i,url:API_ENDPOINT+"/auth/login",dataType:"json",success:function(e){e.u2fEnabled?buildU2FWindow(!!e.mfaEnabled,i):e.mfaEnabled?build2FAWindow(!!e.u2fEnabled,i):e&&!e.error&&e.authToken&&e.renewToken?doLogin(e.authToken,e.renewToken):e&&e.error&&displayErrors($("#loginErrors"),e.error,e.level)},error:function(e){console.error(e)}})}function u2fLoginBegin(e,o){if(o){const n=new Blob([JSON.stringify(e,null,2)],{type:"application/json"});$.ajax({type:"POST",data:n,headers:{"X-Requested-With":"XMLHttpRequest"},contentType:"application/octet-stream; charset=utf-8",processData:!1,dataType:"json",url:`${API_ENDPOINT}/auth/u2f/login-begin-${o}`,success:function({challenge:e,allowed_credentials:o,sessionId:n}){webauthnJSON.get(getU2FLoginOptions(e,o)).then((e=>{u2fLoginFinish(e,n)})).catch((e=>console.warn(e)))}})}else $.ajax({type:"POST",data:e,url:`${API_ENDPOINT}/auth/u2f/login-begin`,success:function({challenge:e,allowed_credentials:o,sessionId:n}){webauthnJSON.get(getU2FLoginOptions(e,o)).then((e=>{u2fLoginFinish(e,n)}))}})}function u2fLoginFinish(e,o){e.response.userHandle="",$.ajax({type:"POST",data:JSON.stringify(e),url:`${API_ENDPOINT}/auth/u2f/login-finish`,headers:{Authorization:`Basic ${o}`},dataType:"json",success:function({authToken:e,renewToken:o}){e&&o&&doLogin(e,o)}})}function getU2FLoginOptions(e,o){return{publicKey:{challenge:e,rpId:window.location.hostname.split(".").slice(-2).join("."),timeout:6e4,userVerification:"discouraged",allowCredentials:o}}}function sendCodeSocial(e){const[o,n]=e;var t=API_ENDPOINT+"/oauth/"+o;n.code=$("#twoFACode").val(),$("#loginErrors").text("").removeClass("tc-warning tc-danger").hide();var a=new Blob([JSON.stringify(n,null,2)],{type:"application/json"});$.ajax({type:"POST",url:t,headers:{"X-Requested-With":"XMLHttpRequest"},contentType:"application/octet-stream; charset=utf-8",processData:!1,dataType:"json",data:a,success:function(e){resetTwoFACodeInput(),e&&!e.error&&e.authToken&&e.renewToken?doLogin(e.authToken,e.renewToken):e&&e.error&&displayErrors($("#loginErrors"),e.error,e.level),$("#googleAuth").removeAttr("disabled")}})}function sendCode(e){const[o]=e;o.code=$("#twoFACode").val(),$("#loginErrors").text("").removeClass("tc-warning tc-danger").hide(),$.ajax({type:"POST",data:o,url:API_ENDPOINT+"/auth/login",dataType:"json",success:function(e){resetTwoFACodeInput(),e&&!e.error&&e.authToken&&e.renewToken?doLogin(e.authToken,e.renewToken):e&&e.error&&displayErrors($("#loginErrors"),e.error,e.level)}})}function parseJwt(e){const o=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(atob(o).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join(""));let t=null;try{t=JSON.parse(n)}catch(e){console.log("Error in JWT parsing",e.getMessage())}return t}function doLogin(e,o){setCookie("authToken",e,{domain:COOOKIE_DOMAIN,path:"/"}),setCookie("renewToken",o,{domain:COOOKIE_DOMAIN,path:"/"}),localStorage.setItem("renewToken",o);const n=parseJwt(e);n&&localStorage.setItem("lastEmail",n.jti);const t=urlParamByName("to"),a=urlParamByName("d");var r="https://app.bitsgap.com";a&&(r="https://"+a+".bitsgap.com"),t?window.open(r+t,"_self"):window.open(r+"/bot","_self")}function getSocialData(e){var o=window.innerWidth+"x"+window.innerHeight,n=window.screen.width+"x"+window.screen.height;return{accessToken:e,regURI:getCookie("ref")||"",res:o,scr:n,referrer:document.referrer}}function sendSocialToken(e,o){$("#"+e+"Auth").attr("disabled","true");var n=getSocialData(o),t=`${API_ENDPOINT}/oauth/${e}`,a=new Blob([JSON.stringify(n,null,2)],{type:"application/json"});$("#loginErrors").text("").removeClass("tc-warning tc-danger").hide(),$("#signupErrors").text("").removeClass("tc-warning tc-danger").hide(),$.ajax({type:"POST",url:t+window.location.search,headers:{"X-Requested-With":"XMLHttpRequest"},contentType:"application/octet-stream; charset=utf-8",processData:!1,data:a,dataType:"json",success:function(o){o.u2fEnabled?buildU2FWindow(!!o.mfaEnabled,n,e):o.mfaEnabled?build2FAWindow(!!o.u2fEnabled,n,e):o&&!o.error&&o.authToken&&o.renewToken?(o.signup&&(ga("create","UA-112734284-1","auto"),ga("send","event","Signup","Signup")),doLogin(o.authToken,o.renewToken)):o&&o.error?(displayErrors($("#loginErrors"),o.error,o.level),displayErrors($("#signupErrors"),o.error,o.level)):o.errors&&Object.keys(o.errors).length>0&&Object.keys(o.errors).forEach((function(e){$("#"+e+"-error").html(o.errors[e][0]).show(),$("#"+e).on("focus",(function(){$("#"+e+"-error").html("").hide()}))})),$("#"+e+"Auth").removeAttr("disabled")}})}function displayErrors(e,o,n){if(Array.isArray(o))o.forEach((function(o){e.append("<div>"+o+"</div>")}));else if("object"==typeof o)for(var t in o)e.append("<div>"+o[t]+"</div>");else e.text(o);n&&"warning"===n?e.addClass("tc-warning"):e.addClass("tc-danger"),e.show()}function getGoogleToken(e){var o=null;return Object.keys(e).forEach((function(n){e[n].hasOwnProperty("id_token")&&(o=e[n].id_token)})),o}function googleAuth(e){e.preventDefault(),e.stopPropagation(),gapi.auth2.getAuthInstance().signIn().then((function(e){var o=getGoogleToken(e);o&&sendSocialToken("google",o)}))}function facebookAuth(e){e.preventDefault(),e.stopPropagation(),FB.getLoginStatus((function(e){console.log(e),"connected"===e.status&&e.authResponse&&e.authResponse.accessToken?sendSocialToken("facebook",e.authResponse.accessToken):FB.login((function(e){console.log(e),e.authResponse&&e.authResponse.accessToken&&sendSocialToken("facebook",e.authResponse.accessToken)}),{scope:"email,public_profile"})}))}function signup(e){e.preventDefault(),e.stopPropagation(),$("label.error").each((function(){$(this).hide()}));var o=$("#mail").val().toLowerCase(),n=$("#password").val(),t=new jsSHA("SHA-512","TEXT");t.update(o+n);var a=t.getHash("HEX"),r=window.innerWidth+"x"+window.innerHeight,i=window.screen.width+"x"+window.screen.height,s={email:o,password:a,regURI:getCookie("ref"),subscribe:Number($("#agree-term-2").val()),res:r,scr:i,referrer:document.referrer};$("#signupErrors").text("").removeClass("tc-warning tc-danger").hide(),$.ajax({url:API_ENDPOINT+"/auth/signup"+window.location.search,type:"POST",dataType:"json",data:s,success:function(e){if(console.log(e),e.errors&&Object.keys(e.errors).length>0)Object.keys(e.errors).forEach((function(o){$("#"+o+"-error").text(e.errors[o][0]).show()}));else if("function"==typeof ga&&(ga("create","UA-112734284-1","auto"),ga("send","event","Signup","Signup")),"/sign-up/"===window.location.pathname)$("main").load("/sign-up/verify-email .ath-container",(function(){updateVerification(o)}));else{var n=$("#register-popup .ath-body").length>0?"#register-popup .ath-body":"#login-popup .ath-body";$(n).load("/sign-up/verify-email .ath-container",(function(){updateVerification(o)}))}}})}function updateVerification(e){$("strong#email-label").text(e);var o=10,n=setInterval((function(){$("span#cnt").text(o),0===--o&&(clearInterval(n),"/sign-up/"===window.location.pathname?window.open("/sign-in","_self"):$("#register-popup .ath-body").length>0?($("#register-popup").modal("hide"),$("#login-popup").modal("show")):loadLoginModal($("#login-popup .ath-container")))}),1e3)}function startCounter(){var e=5,o=setInterval((function(){$("span#cnt").text(e),0===--e&&(clearInterval(o),window.open("/sign-in","_self"))}),1e3)}function setNewPassword(e){e.preventDefault(),e.stopPropagation();var o=atob(window.location.hash.split("?")[0].slice(1)).split("||"),n=$("#reset-password").val();if(""!==n.trim()&&Array.isArray(o)&&2===o.length){var t=o[0],a=o[1],r=API_ENDPOINT+"/auth/password-reset",i=new jsSHA("SHA-512","TEXT");i.update(t+n);var s=i.getHash("HEX");$.ajax({url:r,type:"POST",dataType:"json",data:{password:s,token:a},success:function(e){e.result?$("main").load("/reset-password/success/ .ath-container",(function(){startCounter()})):$("#set-password-errors").text(e.error).addClass("tc-danger").show()}})}}function loadLoginModal(e){e.load("/sign-in/ .ath-body, .ath-note",(function(){$(e).removeAttr("style");var o=$(e).find("#lpassword");o.length>0&&(o.after("<span/>"),$(e).find("#lpassword + span").on("click",(function(){"password"===o[0].type?o[0].type="text":o[0].type="password"}))),$(".ath-container").eq(0).removeClass("contact-wrap"),$("#lemail").val(localStorage.getItem("lastEmail")||""),$("#lemail").val()?$("#lpassword").trigger("focus"):$("#lemail").trigger("focus"),$(".modal-content #forgot-link").on("click",(function(o){o.preventDefault(),o.stopPropagation(),e.load("/reset-password .ath-header, .ath-body, .ath-note",(function(){$(".modal-content #back-to-login").on("click",(function(o){o.preventDefault(),o.stopPropagation(),loadLoginModal(e)})),$("#password-reset-form").on("submit",(function(o){passwordResetRequest(o,e)}))}))})),$(".modal-content a#go-to-signup").on("click",(function(o){o.preventDefault(),o.stopPropagation(),loadSignupModal(e)})),$("#googleAuth").on("click",googleAuth),$("#facebookAuth").on("click",facebookAuth),$("#login-form-modal, #login-form").on("submit",login)}))}function loadSignupModal(e){e.load("/sign-up/ .ath-body, .ath-note",(function(){$(".ath-container").eq(0).removeClass("contact-wrap"),$("#mail").trigger("focus"),$("#googleSignup").on("click",googleAuth),$("#facebookSignup").on("click",facebookAuth),$("#signup-form-modal, #signup-form").on("submit",signup),$("#password").passwordValidator({require:["length","lower","upper","digit"],length:8}),$(".modal-content a#go-to-login").on("click",(function(o){o.preventDefault(),o.stopPropagation(),loadLoginModal(e)}));var o=$(e).find("#password");o.length>0&&(o.after("<span/>"),$(e).find("#password + span").on("click",(function(){"password"===o[0].type?o[0].type="text":o[0].type="password"})))}))}function passwordResetRequest(e,o){e.preventDefault(),e.stopPropagation();var n=$("#reset-email").val();$.ajax({url:API_ENDPOINT+"/auth/password-reset-request",type:"POST",dataType:"json",data:{email:n,static:1},success:function(e){console.log(e),e&&e.error?$("#password-reset-errors").text(e.error).addClass("tc-danger").show():"/reset-password/"===window.location.pathname?$("main").load("/reset-password/verify-email .ath-container",(function(){n&&$("strong#email-label").text(n)})):o.load("/reset-password/verify-email .ath-container",(function(){n&&$("strong#email-label").text(n),$(".ath-container").eq(0).addClass("contact-wrap")}))}})}function resetTwoFACodeInput(e,...o){const n=$("#twoFACode");n.val(""),n.attr("disabled",!1),n.trigger("focus"),n.on("keyup",(function(n){6===n.target.value.length&&($(this).attr("disabled",!0),"function"==typeof e&&e(o))})),n.on("paste",(function(t){const a=t.originalEvent.clipboardData.getData("text").slice(0,6);n.val(a),6===a.length&&($(this).attr("disabled",!0),"function"==typeof e&&e(o))}))}$((function(){getCookie("deleteRenewToken")&&(deleteCookie("deleteRenewToken"),localStorage.removeItem("renewToken")),$("#login-popup").on("shown.bs.modal",(function(){loadLoginModal($("#login-popup .ath-container"))})),$("#register-popup").on("shown.bs.modal",(function(){loadSignupModal($("#register-popup .ath-container"))})),$("#login-btn, #signup-btn").on("click",(function(e){var o=localStorage.getItem("renewToken");o?$.ajax({url:API_ENDPOINT+"/auth-token",type:"POST",dataType:"json",data:{token:o},success:function(n){n.token?(e.preventDefault(),e.stopPropagation(),doLogin(n.token,o)):(localStorage.removeItem("renewToken"),addScript(GOOGLE_SDK_URL),addScript(FACEBOOK_SDK_URL))},error:function(){localStorage.removeItem("renewToken"),addScript(GOOGLE_SDK_URL),addScript(FACEBOOK_SDK_URL)}}):(addScript(GOOGLE_SDK_URL),addScript(FACEBOOK_SDK_URL))})),$("#login-form").on("submit",login),$("#signup-form").on("submit",signup),$("#googleAuth, #googleSignup").on("click",googleAuth),$("#facebookAuth, #facebookSignup").on("click",facebookAuth),$("#password-reset-form").on("submit",passwordResetRequest),$("#forgot-link").on("click",(function(e){e.preventDefault(),e.stopPropagation(),window.open($(this).attr("href"),"_self")})),$("#password").passwordValidator({require:["length","lower","upper","digit"],length:8}),$("#reset-password").passwordValidator({require:["length","lower","upper","digit"],length:8}),$("#set-password-form").on("submit",setNewPassword),$("#lemail").val(localStorage.getItem("lastEmail")||"")}));